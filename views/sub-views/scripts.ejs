<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/3c8decddde.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="/javascripts/script.js"></script> 

<% if (site.editMode) { %>

<!-- Inline Editing -->
<script>
  $(function () {

    toastr.options.closeMethod = 'fadeOut';
    toastr.options.closeDuration = 300;
    toastr.options.closeEasing = 'swing';

    async function changeListener(e) {
      console.log('did this fire?');
      if ($(this).attr('editing') == 'true' || $(this).attr('clickable') == 'true') {
        var id = $(this).data('id');
        var prop = $(this).data('prop');
        var arabizi = $(this).data('arabizi');
        var value = '';
        if ($(this).attr('type') == 'checkbox')
          value = $(this).prop('checked') ? "1" : "0";
        else if ($(this).is('textarea') || $(this).is('select') || $(this).is('input'))
          value = $(this).val();
        else
          value = $(this).html();
        value = value.replace(/&nbsp;/g, ' ');
        value = value.replace(/<div>/g, '\n');
        value = value.replace(/<p>/g, '\n');
        value = value.replace(/<br>/g, '\n');
        value = value.replace(/<\/div>/g, '').trim();
        value = value.replace(/<[^>]+>/g, '');
        var resBody = await update({
          id: id,
          prop: prop,
          arabizi: arabizi,
          value: value,
        });
        // update element on success
        console.log('response: ' + JSON.stringify(resBody).substring(1,255));
        if (resBody.code == 200) {
          value = resBody.value;
          if ($(this).data('reset') == 'true')
            value = '';
          if ($(this).is('textarea') || $(this).is('input'))
            $(this).val(value);
          else if ($(this).is('select'))
            void(0);
          else
            $(this).html(value);
        }
      }
      e.stopPropagation();
    }

    async function update(body) {
      var res = await fetch(`/update/${body.id}/${body.prop}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: body.id,
          prop: body.prop,
          arabizi: body.arabizi,
          value: body.value,
        })
      });
      var body = JSON.parse(await res.text());
      if (res.status == 200)
        toastr.success(`${res.status} ${res.statusText}`, 'Successful Update');
      else {
        var errMessage = `${res.status} ${res.statusText} ${body.message}`;
        console.error(`Update Error\n${errMessage}`);
        toastr.error(errMessage, `Update Error`);
      }
      return body;
    }

    function split(val) {
      return val.split(/ +/);
    }
    function extractLast(term) {
      return split(term).pop();
    }

    $('._e*').each(function () {
      $(this).attr('contenteditable', 'true');
      $(this).on('input', function () {
        $(this).attr('editing', 'true');
        $(this).removeClass('partial');
      });
      $(this).on('blur', changeListener);
    });

    $('._click').each(function () {
      $(this).attr('clickable', 'true');
      $(this).on('click', changeListener);
    });

    $(".tags ._e")
      // don't navigate away from the field on tab when selecting an item
      .on( "keydown", function( event ) {
        if ( event.keyCode === $.ui.keyCode.TAB &&
            $( this ).autocomplete( "instance" ).menu.active ) {
          event.preventDefault();
        }
      })
      .autocomplete({
        source: function( request, response ) {
          $.getJSON('/tag/_list', {
            s: extractLast( request.term )
          }, response );
        },
        search: function() {
          var term = extractLast( $(this).val() );
          if ( term.length < 2 )
            return false;
        },
        focus: function() {
          return false;
        },
        select: function( event, ui ) {
          var terms = split($(this).val());
          terms.pop();
          terms.push(ui.item.value);
          terms.push('');
          $(this).val(terms.join(' '));
          $(this).focus().end();
          return false;
        }
      });
  });
</script> 
<% } %> 

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZFHG1L3ZX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }
  gtag('js', new Date());

  gtag('config', 'G-ZZFHG1L3ZX');
</script>

<!-- Adsense -->
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1199080602686133",
    enable_page_level_ads: true
  });
</script>
<script src="https://www.googleoptimize.com/optimize.js?id=OPT-MCP36TZ"></script>

<!-- Twitter Button -->
<script>window.twttr = (function (d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0],
      t = window.twttr || {};
    if (d.getElementById(id)) return t;
    js = d.createElement(s);
    js.id = id;
    js.src = "https://platform.twitter.com/widgets.js";
    fjs.parentNode.insertBefore(js, fjs);
    t._e = [];
    t.ready = function (f) {
      t._e.push(f);
    };
    return t;
  }(document, "script", "twitter-wjs"));</script>